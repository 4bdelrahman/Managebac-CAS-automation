name: CAS Autopilot

on:
  schedule:
    # Run every 4 days at 10:00 UTC
    - cron: '0 10 */4 * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  run-cas-automation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Install Playwright browsers
      run: |
        playwright install chromium
        playwright install-deps
        
    - name: Run CAS Automation
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        MANAGEBAC_URL: ${{ secrets.MANAGEBAC_URL }}
        MANAGEBAC_USERNAME: ${{ secrets.MANAGEBAC_USERNAME }}
        MANAGEBAC_PASSWORD: ${{ secrets.MANAGEBAC_PASSWORD }}
        TRAINING_DATA_PATH: "Resala CAS Project trainng"
        GEMINI_MODEL: "gemini-1.5-flash-latest"
      run: |
        # 1. Generate Idea
        python execution/generate_idea.py
        
        # 2. Generate Reflection
        python execution/generate_reflection.py --auto
        
        # 3. Submit to ManageBac
        # Note: Headless mode is forced in CI environments usually, 
        # but our script defaults to headless=False. 
        # We might need to ensure it runs headless in CI.
        # For now, let's assume XVFB handles the display or we update the script.
        python execution/submit_to_managebac.py --auto
